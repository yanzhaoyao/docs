# 

## 1.自我介绍

## 2.项目介绍

## 3.算法题

二叉树，给定两个节点，找最近的公共祖先。

## 4.设计题

熔断器：单机接口QPS以万计，设计一个熔断器，每当最近10秒内的接口错误率超过50%，则强制进入5秒的熔断状态，5秒后恢复正常；

> 只考虑单机情况，考虑多线程安全

```java
		public void handle() {
        if (cb.check()) {
            boolean result = doBusiness();
            cb.update(result);
        }
    }

    public interface CB {
        boolean check();

        void update(boolean result);
    }
```

当场没答出来（面试应该凉凉了），后面下来，自己多思考了一下，代码如下：

CB.java

```java
public interface CB {
    boolean check();
    void update(boolean result);
}
```

CBImpl.java

```java
public class CBImpl implements CB {
    // 滑动窗口，单位毫秒
    private long slidingWindowMillis;
    // 错误率，范围0-100
    private BigDecimal errorRatio;
    // 熔断开关
    volatile boolean isBreaked = false;
    // 统计队列（全部请求）
    Queue<Long> total = new ConcurrentLinkedDeque<>();
    // 统计队列（错误请求）
    Queue<Long> error = new ConcurrentLinkedDeque<>();

    public CBImpl() {
        this(10 * 1000L, new BigDecimal("0.5"));
    }

    public CBImpl(long slidingWindowMillis, BigDecimal errorRatio) {
        this.slidingWindowMillis = slidingWindowMillis;
        this.errorRatio = errorRatio;
        new Thread(() -> {
            while (true) {
                Long current = System.currentTimeMillis();
                Long before = current - slidingWindowMillis;
                if (!total.isEmpty() && total.peek() < before) {
                    total.poll();
                }
                if (!error.isEmpty() && error.peek() < before) {
                    error.poll();
                }
            }
        }).start();
    }

    @Override
    public boolean check() {
        System.out.println("当前错误率：" + errorRatio());
        if (isBreaked) {
            return false;
        }
        if (errorRatio().compareTo(errorRatio) > 0) {
            System.out.println("------错误率超过" + errorRatio + "------");
            breaked();
            return false;
        }
        System.out.println("------正常请求------");
        return true;
    }

    @Override
    public void update(boolean result) {
        Long current = System.currentTimeMillis();
        total.offer(current);
        if (!result) {
            error.offer(current);
        }
    }

    /**
     * 熔断
     */
    private void breaked() {
        new Thread(() -> {
            System.out.println("------熔断开始------" + new Date());
            isBreaked = true;
            try {
                Thread.sleep(5000L);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            isBreaked = false;
            System.out.println("------熔断结束------" + new Date());
        }).start();
    }

    /**
     * 错误率
     *
     * @return
     */
    public BigDecimal errorRatio() {
        if (error.size() == 0 || total.size() == 0) {
            return BigDecimal.ZERO;
        }
        return new BigDecimal(error.size()).divide(new BigDecimal(total.size()), 4, BigDecimal.ROUND_HALF_UP);
    }
}
```

CBTest.java

```java
public class CBTest {

    private CB cb = new CBImpl();

    public void handle() {
        if (cb.check()) {
            boolean result = doBusiness();
            cb.update(result);
        }
    }

    /**
     * 模拟错误
     *
     * @return false 为错误请求 true为成功请求
     */
    private boolean doBusiness() {
        return Math.random() > 0.46;
    }

    public static void main(String[] args) throws InterruptedException {
        CBTest CBTest = new CBTest();
        while (true) {
            CBTest.handle();
            Thread.sleep(200L);
        }
    }

}
```



测试结果

```java
当前错误率：0
------正常请求------
当前错误率：0
------正常请求------
当前错误率：0
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.5000
------正常请求------
当前错误率：0.4000
------正常请求------
当前错误率：0.5000
------正常请求------
当前错误率：0.4286
------正常请求------
当前错误率：0.3750
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.3000
------正常请求------
当前错误率：0.3636
------正常请求------
当前错误率：0.4167
------正常请求------
当前错误率：0.4615
------正常请求------
当前错误率：0.5000
------正常请求------
当前错误率：0.5333
------错误率超过0.5------
------熔断开始------Wed Nov 25 14:38:35 CST 2020
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
------熔断结束------Wed Nov 25 14:38:40 CST 2020
当前错误率：0.5333
------错误率超过0.5------
------熔断开始------Wed Nov 25 14:38:40 CST 2020
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5333
当前错误率：0.5714
当前错误率：0.6154
当前错误率：0.5833
当前错误率：0.5455
当前错误率：0.6000
当前错误率：0.5556
当前错误率：0.6250
当前错误率：0.7143
当前错误率：0.8333
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：0
------熔断结束------Wed Nov 25 14:38:45 CST 2020
当前错误率：0
------正常请求------
当前错误率：1.0000
------错误率超过0.5------
------熔断开始------Wed Nov 25 14:38:45 CST 2020
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
------熔断结束------Wed Nov 25 14:38:50 CST 2020
当前错误率：1.0000
------错误率超过0.5------
------熔断开始------Wed Nov 25 14:38:50 CST 2020
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：1.0000
当前错误率：0
------熔断结束------Wed Nov 25 14:38:55 CST 2020
当前错误率：0
------正常请求------
当前错误率：0
------正常请求------
当前错误率：0.5000
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.5000
------正常请求------
当前错误率：0.6000
------错误率超过0.5------
------熔断开始------Wed Nov 25 14:38:56 CST 2020
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
------熔断结束------Wed Nov 25 14:39:01 CST 2020
当前错误率：0.6000
------错误率超过0.5------
------熔断开始------Wed Nov 25 14:39:01 CST 2020
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.6000
当前错误率：0.7500
当前错误率：0.6667
当前错误率：1.0000
当前错误率：1.0000
当前错误率：0
------熔断结束------Wed Nov 25 14:39:06 CST 2020
当前错误率：0
------正常请求------
当前错误率：0
------正常请求------
当前错误率：0
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.5000
------正常请求------
当前错误率：0.4000
------正常请求------
当前错误率：0.5000
------正常请求------
当前错误率：0.4286
------正常请求------
当前错误率：0.3750
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.3000
------正常请求------
当前错误率：0.3636
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.3077
------正常请求------
当前错误率：0.3571
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.3125
------正常请求------
当前错误率：0.2941
------正常请求------
当前错误率：0.2778
------正常请求------
当前错误率：0.2632
------正常请求------
当前错误率：0.2500
------正常请求------
当前错误率：0.2381
------正常请求------
当前错误率：0.2273
------正常请求------
当前错误率：0.2609
------正常请求------
当前错误率：0.2917
------正常请求------
当前错误率：0.3200
------正常请求------
当前错误率：0.3077
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.3214
------正常请求------
当前错误率：0.3103
------正常请求------
当前错误率：0.3000
------正常请求------
当前错误率：0.3226
------正常请求------
当前错误率：0.3438
------正常请求------
当前错误率：0.3333
------正常请求------
当前错误率：0.3235
------正常请求------
当前错误率：0.3429
------正常请求------
当前错误率：0.3611
------正常请求------
当前错误率：0.3784
------正常请求------
当前错误率：0.3684
------正常请求------
当前错误率：0.3846
------正常请求------
当前错误率：0.3750
------正常请求------
当前错误率：0.3659
------正常请求------
当前错误率：0.3571
------正常请求------
当前错误率：0.3721
------正常请求------
当前错误率：0.3864
------正常请求------
当前错误率：0.4000
------正常请求------
当前错误率：0.3913
------正常请求------
当前错误率：0.4043
------正常请求------
当前错误率：0.3958
------正常请求------
当前错误率：0.3878
------正常请求------
当前错误率：0.3878
------正常请求------
当前错误率：0.3878
------正常请求------
当前错误率：0.3673
------正常请求------
当前错误率：0.3673
------正常请求------
当前错误率：0.3878
------正常请求------
当前错误率：0.3673
------正常请求------
当前错误率：0.3673
------正常请求------
```

